import lingo/pegcode/driver;


ArExpr ::= ArSum, ArMult, ArSub, ArDiv, ArInt, ArMod, Identifier;
	ArSum(lhs : ArExpr, rhs : ArExpr);
	ArMult(lhs : ArExpr, rhs : ArExpr);
	ArSub(lhs : ArExpr, rhs : ArExpr);
	ArDiv(lhs : ArExpr, rhs : ArExpr);
	ArMod(lhs : ArExpr, rhs : ArExpr);
	ArInt(x : int);
	Identifier(id : string);


Statement ::= VarAssign, VarDecl, Test;
	VarAssign(id : Identifier, expr : ArExpr);
	VarDecl(id : Identifier, type : Type);
	Test(expr : ArExpr);

Type(t : string);

Block(stmts : [Statement]);

block2s (b : Block) -> string {
	println("Start block");
	switch (b : Block) {
		Block(stmts): {
			println("2 block");
			"Block(" + stmts2s(stmts) + ")"
		}
	}
}

stmts2s (stmts : [Statement]) -> string {
	if (length(stmts) == 0) 
		""
	else if (length(stmts) == 1)
		state2s(stmts[0])
	else
		state2s(stmts[0]) + ", " + stmts2s(tail(stmts))
}

state2s (s : Statement) -> string {
	switch (s : Statement) {
		VarAssign(id, expr): {
			"Assign(" + id2s(id) + ", " + ar2s(expr) + ")"
		}
		VarDecl(id, type): {
			"VarDecl(" + id2s(id) + ", " + type2s(type) + ")"
		}
		Test(e): {
			"Test(" + ar2s(e) + ")"
		}
	}
}

type2s (type : Type) -> string {
	switch (type : Type) {
		Type(val): {
			"Type(" + val + ")"
		}
	}
}

id2s (id : Identifier) -> string {
	switch (id : Identifier) {
		Identifier(val): {
			"Id(" + val + ")"
		}
	}
}

ar2s (e : ArExpr) -> string {
	switch (e : ArExpr) {
		ArSum(lhs, rhs): {
			"ArSum(" + ar2s(lhs) + ", " + ar2s(rhs) + ")";
		};
		ArMult(lhs, rhs): {
			"ArMult(" + ar2s(lhs) + ", " + ar2s(rhs) + ")";
		};
		ArSub(lhs, rhs): {
			"ArSub(" + ar2s(lhs) + ", " + ar2s(rhs) + ")";
		};
		ArDiv(lhs, rhs): {
			"ArDiv(" + ar2s(lhs) + ", " + ar2s(rhs) + ")";
		};
		ArMod(lhs, rhs): {
			"ArMod(" + ar2s(lhs) + ", " + ar2s(rhs) + ")";
		};
		ArInt(x): { i2s(x) };
		Identifier(id) : { id2s(e) }
	}
}


s2statement(str : string) -> Statement {
	e_gr = "#include education/nsu_translation-and-compilation-methods/NeMo_compiler/program.lingo";
	parsic(
		compilePegGrammar(e_gr), 
		str,
		defaultPegActions
		//SemanticActions(setTree(defaultPegActions.t, "createArInt", \s -> VarAssign(s[0])))
	)
}

s2block(str : string) -> Block {
	e_gr = "#include education/nsu_translation-and-compilation-methods/NeMo_compiler/program.lingo";
	parsic(
		compilePegGrammar(e_gr), 
		str,
		defaultPegActions
		//SemanticActions(setTree(defaultPegActions.t, "createArInt", \s -> VarAssign(s[0])))
	)
}


main() -> int {
	ar = s2block("{ 
		VAR x: INT;
		VAR y: INT; 
		x := (( (4 - 5 ) * ( 18 + 3)) + ((eee % 2) / 5));	
		y := 131;
		(x * 5)?;
	}");

	println("Raw AST:");
	println(ar);

	println("AST: " + block2s(ar));

	0;
}
